{"BLOG_INFO":{"author":"tencent-cloud-native","blogStats":{"buryCount":0,"diggCount":0,"feedbackCount":0,"postId":16312457,"viewCount":609},"content":"<div id=\"cnblogs_post_body\" class=\"blogpost-body cnblogs-markdown\">\n <h2 id=\"作者\">作者</h2>\n <p>刘旭，腾讯云高级工程师，专注容器云原生领域，有多年大规模 Kubernetes 集群管理经验，现负责腾讯云 GPU 容器的研发工作。</p>\n <h2 id=\"背景\">背景</h2>\n <p>目前 TKE 已提供基于 qGPU 的算力/显存强隔离的共享 GPU 调度隔离方案，但是部分用户反馈缺乏 GPU 资源的可观测性，例如无法获取单个 GPU 设备的剩余资源，不利于 GPU 资源的运维和管理。在这种背景下，我们希望提供一种方案，可以让用户在 Kubernetes 集群中直观的统计和查询 GPU 资源的使用情况。</p>\n <h2 id=\"目标\">目标</h2>\n <p>在目前 TKE 共享 GPU 调度方案的基础上，从以下几个方面增强 GPU 设备的可观测性：</p>\n <ul>\n  <li><p>支持获取单个 GPU 设备的资源分配信息。</p></li>\n  <li><p>支持获取单个 GPU 设备的健康状态。</p></li>\n  <li><p>支持获取某个节点上各 GPU 设备信息。</p></li>\n  <li><p>支持获取 GPU 设备和 Pod / Container 关联信息。</p></li>\n </ul>\n <h2 id=\"我们的方案\">我们的方案</h2>\n <p>我们通过 GPU CRD 扫描物理 GPU 的信息，并在 qGPU 生命周期中更新使用到的物理 GPU 资源，从而解决在共享 GPU 场景下缺少可见性的问题。</p>\n <ul>\n  <li><p><strong>自定义 GPU CRD</strong>：每个 GPU 设备对应一个 GPU 对象，通过 GPU 对象可以获取 GPU 设备的硬件信息，健康状态以及资源分配情况。</p></li>\n  <li><p><strong>Elastic GPU Device Plugin</strong>：根据 GPU 设备的硬件信息创建 GPU 对象，定期更新 GPU 设备的健康状态。</p></li>\n  <li><p><strong>Elastic GPU Scheduler</strong>：根据 GPU 资源使用情况调度 Pod，同时将调度结果更新到 GPU 对象。</p></li>\n </ul>\n <p><img src=\"https://img2022.cnblogs.com/other/2041406/202205/2041406-20220526100938692-1866621066.png\" alt=\"\" loading=\"lazy\"></p>\n <h3 id=\"tke-gpu-crd-设计\">TKE GPU CRD 设计</h3>\n <pre><code class=\"language-yaml\">apiVersion: elasticgpu.io/v1alpha1\nkind: GPU\nmetadata:\n  labels:\n    elasticgpu.io/node: 10.0.0.2\n  name: 192.168.2.5-00\nspec:\n  index: 0\n  memory: 34089730048\n  model: Tesla V100-SXM2-32GB\n  nodeName: 10.0.0.2\n  path: /dev/nvidia0\n  uuid: GPU-cf0f5fe7-0e15-4915-be3c-a6d976d65ad4\nstatus:\n  state: Healthy\n  allocatable:\n    tke.cloud.tencent.com/qgpu-core: \"50\"\n    tke.cloud.tencent.com/qgpu-memory: \"23\"\n  allocated:\n    0dc3c905-2955-4346-b74e-7e65e29368d2:\n      containers:\n      - container: test\n        resource:\n          tke.cloud.tencent.com/qgpu-core: \"50\"\n          tke.cloud.tencent.com/qgpu-memory: \"8\"\n      namespace: default\n      pod: test\n  capacity:\n    tke.cloud.tencent.com/qgpu-core: \"100\"\n    tke.cloud.tencent.com/qgpu-memory: \"31\"\n</code></pre>\n <p>每个 GPU 物理卡对应一个 GPU CRD，通过 GPU CRD 可以清楚了解每张卡的型号，显存等硬件信息，同时通过 <code>status</code> 可以获取每个 GPU 设备的健康状态和资源分配情况。</p>\n <h3 id=\"tke-gpu-调度过程\">TKE GPU 调度过程</h3>\n <p><img src=\"https://img2022.cnblogs.com/other/2041406/202205/2041406-20220526100939635-1481093380.png\" alt=\"\" loading=\"lazy\"></p>\n <p>Kubernetes 提供了 Scheduler Extender 用于对调度器进行扩展，用于满足复杂场景下的调度需求。扩展后的调度器会在调用内置预选策略和优选策略之后通过 HTTP 协议调用扩展程序再次进行预选和优选，最后选择一个合适的 Node 进行 Pod 的调度。</p>\n <p>在 TKE Elastic GPU Scheduler（原 TKE qGPU Scheduler），我们结合了 GPU CRD 设计，在调度时首先会根据 <code>status.state</code> 过滤掉异常 GPU 设备，然后根据 <code>status.allocatable</code> 选择剩余资源满足需求的 GPU 设备，在最终完成调度时更新 <code>status.allocatable</code> 和 <code>status.allocated</code> 。</p>\n <h3 id=\"tke-gpu-分配过程\">TKE GPU 分配过程</h3>\n <p><img src=\"https://img2022.cnblogs.com/other/2041406/202205/2041406-20220526100940577-2053575272.png\" alt=\"\" loading=\"lazy\"></p>\n <p>Kubernetes 提供了 Device Plugin 机制用于支持 GPU FPGA 等硬件设备，设备厂商只需要根据接口实现 Device Plugin 而不需要修改 Kubernetes 源码，Device Plugin 一般以 DaemonSet 的形式运行在节点上。</p>\n <p>我们在 TKE Elastic GPU Device Plugin（原 TKE qGPU Device Plugin）启动时会根据节点上 GPU 设备的硬件信息创建 GPU 对象，同时会定期检查 GPU 设备的健康状态并同步到 GPU 对象的 <code>status.state</code>。</p>\n <h2 id=\"总结\">总结</h2>\n <p>为了解决目前 TKE 集群内 GPU 资源可观测性缺失的问题，我们引入了 GPU CRD，用户可以直观的统计和查询集群内 GPU 资源的使用情况，目前这套方案已和 qGPU 完成整合，在 TKE 控制台安装 qGPU 插件时选择使用 CRD 即可开启。</p>\n <p>目前 TKE qGPU 已全量上线，详情请戳：<a href=\"https://cloud.tencent.com/document/product/457/61448\" target=\"_blank\" rel=\"noopener nofollow\">https://cloud.tencent.com/document/product/457/61448</a></p>\n <h2 id=\"关于我们\">关于我们</h2>\n <p>更多关于云原生的案例和知识，可关注同名【腾讯云原生】公众号~</p>\n <h4 id=\"福利\">福利：</h4>\n <p>①公众号后台回复【手册】，可获得《腾讯云原生路线图手册》&amp;《腾讯云原生最佳实践》~</p>\n <p>②公众号后台回复【系列】，可获得《15个系列100+篇超实用云原生原创干货合集》，包含Kubernetes 降本增效、K8s 性能优化实践、最佳实践等系列。</p>\n <p>③公众号后台回复【白皮书】，可获得《腾讯云容器安全白皮书》&amp;《降本之源-云原生成本管理白皮书v1.0》</p>\n <p>④公众号后台回复【光速入门】，可获得腾讯云专家5万字精华教程，光速入门Prometheus和Grafana。</p>\n <blockquote>\n  <p>【腾讯云原生】云说新品、云研新术、云游新活、云赏资讯，扫码关注同名公众号，及时获取更多干货！！<br><img src=\"https://img2022.cnblogs.com/other/2041406/202205/2041406-20220526100940933-2019752012.png\" alt=\"\" loading=\"lazy\"></p>\n </blockquote>\n</div>","date":12535800000,"id":"16312457","tags":[],"title":"TKE qGPU 通过 CRD 管理集群 GPU 卡资源","url":"https://www.cnblogs.com/tencent-cloud-native/p/16312457.html"}}